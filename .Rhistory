wrp_regions <- wrp_dictionary[wrp_dictionary$WRP_UID %in% regional_ids, ]
wrp_disaggregations <- wrp_dictionary[substr(wrp_dictionary$WRP_UID, 1, 3) ==
"DIS", ]
wrp_questions <- wrp_dictionary[substr(wrp_dictionary$WRP_UID, 1, 1) == "Q", ]
wrp_questions$WRP_UID <- toupper(wrp_questions$variable)
wrp_needed = wrp_dictionary[substr(wrp_dictionary$WRP_UID, 1, 4) == "NEED", ]
View(wrp_needed)
usethis::use_data(wrp_data,
wrp_year_col,
wrp_projweight_col,
wrp_weight_col,
wrp_regions,
wrp_disaggregations,
wrp_questions,
overwrite = TRUE,
internal = TRUE,
compress = "xz")
# Set up data frame
wrp_geography_col <- .get_regional_column(geography)
wrp_question_col <- .get_question_column(wrp_question_uid)
wrp_wgt_col <- .get_weight_column(wrp_geography_col)
# Aggregate data using weights
wrp_agg <- lapply(wrp_disaggregations$pos, function(i) {
tmp <- wrp_data[, c(
wrp_geography_col, i, wrp_year_col, wrp_wgt_col,
wrp_question_col
)]
tmp <- tmp[!is.na(tmp[, 5]), ] %>%
wrp_aggregate() %>%
wrp_clean()
}) %>%
bind_rows()
library(labelled)
# Aggregate data using weights
wrp_agg <- lapply(wrp_disaggregations$pos, function(i) {
tmp <- wrp_data[, c(
wrp_geography_col, i, wrp_year_col, wrp_wgt_col,
wrp_question_col
)]
tmp <- tmp[!is.na(tmp[, 5]), ] %>%
wrp_aggregate() %>%
wrp_clean()
}) %>%
bind_rows()
library(janitor)
# Aggregate data using weights
wrp_agg <- lapply(wrp_disaggregations$pos, function(i) {
tmp <- wrp_data[, c(
wrp_geography_col, i, wrp_year_col, wrp_wgt_col,
wrp_question_col
)]
tmp <- tmp[!is.na(tmp[, 5]), ] %>%
wrp_aggregate() %>%
wrp_clean()
}) %>%
bind_rows()
# Output summary
message(paste("You have selected:", wrp_question_uid))
message("This question asks:")
message(wrp_agg$question[1])
question_summary <- wrp_agg %>%
group_by(.data$year) %>%
summarise(n = length(unique(.data$geography))) %>%
ungroup() %>%
arrange(.data$year)
.print_question_summary(question_summary)
source("~/Documents/github/wrp/R/print_question_summary.R", echo=TRUE)
source("~/Documents/github/wrp/R/print_one_year_summary.R", echo=TRUE)
source("~/Documents/github/wrp/R/print_two_year_summary.R", echo=TRUE)
.print_question_summary(question_summary)
View(wrp_data)
source("~/Documents/github/wrp/data-raw/format_wrp_from_raw.R", echo=TRUE)
source("~/Documents/github/wrp/data-raw/format_wrp_from_raw.R", echo=TRUE)
source("~/Documents/github/wrp/data-raw/format_wrp_from_raw.R", echo=TRUE)
wrp_data = remove_all_labels(wrp_data)
View(wrp_data)
usethis::use_data(wrp_data,
wrp_year_col,
wrp_projweight_col,
wrp_weight_col,
wrp_regions,
wrp_disaggregations,
wrp_questions,
overwrite = TRUE,
internal = TRUE,
compress = "xz")
source("~/Documents/github/wrp/data-raw/format_wrp_from_raw.R", echo=TRUE)
source("~/Documents/github/wrp/data-raw/format_wrp_from_raw.R", echo=TRUE)
View(wrp_disaggregations)
wrp_dictionary <- labelled::generate_dictionary(wrp_data)
View(wrp_dictionary)
View(wrp_dictionary)
wrp_data <- raw %>%
janitor::clean_names("lower_camel") %>%
# change 1: convert haven_labelled variables to factors ----
mutate_if(haven::is.labelled, haven::as_factor)
wrp_data$countryIncomeLevel <- as.character(wrp_data$countryIncomeLevel2019)
wrp_data$countryIncomeLevel <- ifelse(is.na(wrp_data$countryIncomeLevel),
as.character(wrp_data$countryIncomeLevel2021), wrp_data$countryIncomeLevel
)
wrp_dictionary <- labelled::generate_dictionary(wrp_data) %>%
mutate(regional_disaggregate = pos %in% c(2, 6, 233)) %>%
mutate(disaggregator = pos %in% c(3, 13:19)) %>%
mutate(question = substr(variable, 1, 1) == "q" |
substr(variable, 1, 2) == "vh") %>%
mutate(needed = variable %in% c("year", "wgt", "projectionWeight"))
View(wrp_dictionary)
source("~/Documents/github/wrp/data-raw/format_wrp_from_raw.R", echo=TRUE)
View(wrp_disaggregations)
View(wrp_dictionary)
View(wrp_disaggregations)
View(wrp_dictionary)
wrp_data <- raw %>%
janitor::clean_names("lower_camel") %>%
# change 1: convert haven_labelled variables to factors ----
mutate_if(haven::is.labelled, haven::as_factor)
View(wrp_data)
wrp_data$countryIncomeLevel <- as.character(wrp_data$countryIncomeLevel2019)
wrp_data$countryIncomeLevel <- ifelse(is.na(wrp_data$countryIncomeLevel),
as.character(wrp_data$countryIncomeLevel2021), wrp_data$countryIncomeLevel
)
wrp_dictionary <- labelled::generate_dictionary(wrp_data) %>%
mutate(regional_disaggregate = pos %in% c(2, 6, 233)) %>%
mutate(disaggregator = pos %in% c(3, 13:15, 17:19)) %>%
mutate(question = substr(variable, 1, 1) == "q" |
substr(variable, 1, 2) == "vh") %>%
mutate(needed = variable %in% c("year", "wgt", "projectionWeight"))
View(wrp_dictionary)
wrp_dictionary$label <- ifelse((wrp_dictionary$variable == "countryIncomeLevel"),
"World Bank Income Levels", wrp_dictionary$label)
wrp_dictionary$label <- ifelse((wrp_dictionary$variable == "projectionWeight"),
"projectionWeight", wrp_dictionary$label)
wrp_dictionary <- wrp_dictionary[wrp_dictionary$regional_disaggregate |
wrp_dictionary$disaggregator |
wrp_dictionary$question |
wrp_dictionary$needed, ]
View(wrp_disaggregations)
wrp_data = wrp_data[,c(wrp_dictionary$pos)]
wrp_dictionary$pos = match(wrp_dictionary$variable, names(wrp_data))
wrp_year_col <- match("year", wrp_dictionary$variable)
wrp_weight_col <- match("wgt", wrp_dictionary$variable)
wrp_projweight_col <- match("projectionWeight", wrp_dictionary$variable)
wrp_dictionary$WRP_UID <- NA
regional_ids <- c("country", "region", "income")
wrp_dictionary$WRP_UID[wrp_dictionary$regional_disaggregate] <- regional_ids
wrp_dictionary$WRP_UID[wrp_dictionary$disaggregator] <-
paste0("DIS", 1:sum(wrp_dictionary$disaggregator))
wrp_dictionary$WRP_UID[wrp_dictionary$question] <-
paste0("Q", 1:sum(wrp_dictionary$question))
wrp_dictionary$WRP_UID[wrp_dictionary$needed] <-
paste0("NEED", 1:sum(wrp_dictionary$needed))
wrp_dictionary <- wrp_dictionary %>%
select(WRP_UID, pos, variable, label, levels)
wrp_regions <- wrp_dictionary[wrp_dictionary$WRP_UID %in% regional_ids, ]
wrp_disaggregations <- wrp_dictionary[substr(wrp_dictionary$WRP_UID, 1, 3) ==
"DIS", ]
wrp_questions <- wrp_dictionary[substr(wrp_dictionary$WRP_UID, 1, 1) == "Q", ]
wrp_questions$WRP_UID <- toupper(wrp_questions$variable)
wrp_needed = wrp_dictionary[substr(wrp_dictionary$WRP_UID, 1, 4) == "NEED", ]
wrp_data = remove_all_labels(wrp_data)
View(wrp_disaggregations)
View(wrp_questions)
View(wrp_regions)
wrp_regions = wrp_regions %>% select(-labels)
wrp_regions = wrp_regions %>% select(-label)
wrp_disaggregations = wrp_disaggregations %>% select(-label)
usethis::use_data(wrp_data,
wrp_year_col,
wrp_projweight_col,
wrp_weight_col,
wrp_regions,
wrp_disaggregations,
wrp_questions,
overwrite = TRUE,
internal = TRUE,
compress = "xz")
# Set up data frame
wrp_geography_col <- .get_regional_column(geography)
wrp_question_col <- .get_question_column(wrp_question_uid)
wrp_wgt_col <- .get_weight_column(wrp_geography_col)
# Aggregate data using weights
wrp_agg <- lapply(wrp_disaggregations$pos, function(i) {
tmp <- wrp_data[, c(
wrp_geography_col, i, wrp_year_col, wrp_wgt_col,
wrp_question_col
)]
tmp <- tmp[!is.na(tmp[, 5]), ] %>%
wrp_aggregate() %>%
wrp_clean()
}) %>%
bind_rows()
wrp_disaggregations$pos
i = 2
tmp <- wrp_data[, c(
wrp_geography_col, i, wrp_year_col, wrp_wgt_col,
wrp_question_col
)]
View(tmp)
# Aggregate data using weights
wrp_agg <- lapply(wrp_disaggregations$pos, function(i) {
tmp <- wrp_data[, c(
wrp_geography_col, i, wrp_year_col, wrp_wgt_col,
wrp_question_col
)]
tmp <- tmp[!is.na(tmp[, 5]), ] %>%
wrp_aggregate() %>%
wrp_clean()
}) %>%
bind_rows()
source("~/Documents/github/wrp/R/wrp_clean.R", echo=TRUE)
# Aggregate data using weights
wrp_agg <- lapply(wrp_disaggregations$pos, function(i) {
tmp <- wrp_data[, c(
wrp_geography_col, i, wrp_year_col, wrp_wgt_col,
wrp_question_col
)]
tmp <- tmp[!is.na(tmp[, 5]), ] %>%
wrp_aggregate() %>%
wrp_clean()
}) %>%
bind_rows()
tmp <- wrp_data[, c(
wrp_geography_col, i, wrp_year_col, wrp_wgt_col,
wrp_question_col
)]
tmp <- tmp[!is.na(tmp[, 5]), ]
tmp <- tmp[!is.na(tmp[, 5]), ] %>%
wrp_aggregate()
df <- df %>% mutate(disaggregation = names(df)[2], question = names(df)[4])
df = tmp
df <- df %>% mutate(disaggregation = names(df)[2], question = names(df)[4])
names(df)[1] <- "geography"
names(df)[4] <- "response"
names(df)[2] <- "group"
df <- df %>%
mutate_if(is.factor, as.character) %>%
clean_names("lower_camel")
df <- df[, c(1, 6, 2, 8, 7, 4, 5)]
# Aggregate data using weights
wrp_agg <- lapply(wrp_disaggregations$pos, function(i) {
tmp <- wrp_data[, c(
wrp_geography_col, i, wrp_year_col, wrp_wgt_col,
wrp_question_col
)]
tmp <- tmp[!is.na(tmp[, 5]), ] %>%
wrp_aggregate() %>%
wrp_clean()
}) %>%
bind_rows()
source("~/Documents/github/wrp/R/wrp_clean.R", echo=TRUE)
# Aggregate data using weights
wrp_agg <- lapply(wrp_disaggregations$pos, function(i) {
tmp <- wrp_data[, c(
wrp_geography_col, i, wrp_year_col, wrp_wgt_col,
wrp_question_col
)]
tmp <- tmp[!is.na(tmp[, 5]), ] %>%
wrp_aggregate() %>%
wrp_clean()
}) %>%
bind_rows()
View(wrp_agg)
source("~/Documents/github/wrp/data-raw/format_wrp_from_raw.R", echo=TRUE)
# Set up data frame
wrp_geography_col <- .get_regional_column(geography)
wrp_question_col <- .get_question_column(wrp_question_uid)
wrp_wgt_col <- .get_weight_column(wrp_geography_col)
# Aggregate data using weights
wrp_agg <- lapply(wrp_disaggregations$pos, function(i) {
tmp <- wrp_data[, c(
wrp_geography_col, i, wrp_year_col, wrp_wgt_col,
wrp_question_col
)]
tmp <- tmp[!is.na(tmp[, 5]), ] %>%
wrp_aggregate() %>%
wrp_clean()
}) %>%
bind_rows()
View(wrp_agg)
View(wrp_agg)
View(wrp_agg)
source("~/Documents/github/wrp/R/wrp_clean.R", echo=TRUE)
# Aggregate data using weights
wrp_agg <- lapply(wrp_disaggregations$pos, function(i) {
tmp <- wrp_data[, c(
wrp_geography_col, i, wrp_year_col, wrp_wgt_col,
wrp_question_col
)]
tmp <- tmp[!is.na(tmp[, 5]), ] %>%
wrp_aggregate() %>%
wrp_clean()
}) %>%
bind_rows()
View(wrp_agg)
roxygen2::roxygenise()
View(wrp_disaggregations)
?gsub
roxygen2::roxygenise()
wrp_dictionary <- labelled::generate_dictionary(wrp_data) %>%
mutate(regional_disaggregate = pos %in% c(2, 6, 233)) %>%
mutate(disaggregator = pos %in% c(3, 13:15, 17:19)) %>%
mutate(question = substr(variable, 1, 1) == "q" |
substr(variable, 1, 2) == "vh") %>%
mutate(needed = variable %in% c("year", "wgt", "projectionWeight"))
View(wrp_disaggregations)
View(wrp_dictionary)
wrp_data <- raw %>%
janitor::clean_names("lower_camel") %>%
# change 1: convert haven_labelled variables to factors ----
mutate_if(haven::is.labelled, haven::as_factor)
wrp_data$countryIncomeLevel <- as.character(wrp_data$countryIncomeLevel2019)
wrp_data$countryIncomeLevel <- ifelse(is.na(wrp_data$countryIncomeLevel),
as.character(wrp_data$countryIncomeLevel2021), wrp_data$countryIncomeLevel
)
wrp_dictionary <- labelled::generate_dictionary(wrp_data) %>%
mutate(regional_disaggregate = pos %in% c(2, 6, 233)) %>%
mutate(disaggregator = pos %in% c(3, 13:15, 17:19)) %>%
mutate(question = substr(variable, 1, 1) == "q" |
substr(variable, 1, 2) == "vh") %>%
mutate(needed = variable %in% c("year", "wgt", "projectionWeight"))
View(wrp_dictionary)
source("~/Documents/github/wrp/data-raw/format_wrp_from_raw.R", echo=TRUE)
roxygen2::roxygenise()
roxygen2::roxygenise()
source("~/Documents/github/wrp/data-raw/format_wrp_from_raw.R", echo=TRUE)
source("~/Documents/github/wrp/data-raw/format_wrp_from_raw.R", echo=TRUE)
View(wrp_regions)
#wrp_data = remove_all_labels(wrp_data)
wrp_regions = wrp_regions %>% select(-label)
source("~/Documents/github/wrp/data-raw/format_wrp_from_raw.R", echo=TRUE)
View(wrp_disaggregations)
View(wrp_disaggregations)
source("~/Documents/github/wrp/data-raw/format_wrp_from_raw.R", echo=TRUE)
View(wrp_disaggregations)
wrp_data <- raw %>%
janitor::clean_names("lower_camel") %>%
# change 1: convert haven_labelled variables to factors ----
mutate_if(haven::is.labelled, haven::as_factor)
wrp_data$countryIncomeLevel <- as.character(wrp_data$countryIncomeLevel2019)
wrp_data$countryIncomeLevel <- ifelse(is.na(wrp_data$countryIncomeLevel),
as.character(wrp_data$countryIncomeLevel2021), wrp_data$countryIncomeLevel
)
wrp_dictionary <- labelled::generate_dictionary(wrp_data) %>%
mutate(regional_disaggregate = pos %in% c(2, 6)) %>%
mutate(disaggregator = pos %in% c(3, 13:15, 17)) %>%
mutate(question = substr(variable, 1, 1) == "q" |
substr(variable, 1, 2) == "vh") %>%
mutate(needed = variable %in% c("year", "wgt", "projectionWeight"))
View(wrp_dictionary)
source("~/Documents/github/wrp/data-raw/format_wrp_from_raw.R", echo=TRUE)
install.packages('rhub')
hub::check_for_cran()
rhub::check_for_cran()
devtools::spell_check()
devtools::release()
devtools::release()
library(worldriskpollr)
roxygen2::roxygenise()
library(worldriskpollr)
wrp_get(geography = "country", wrp_question_uid = "Q1")
wrp_get(geography = "country", wrp_question_uid = "Q1")
usethis::use_test()
roxygen2::roxygenise()
roxygen2::roxygenise()
library(worldriskpollr)
library(worldriskpollr)
x = wrp_search("violence")
# Set up data frame
pkg_info = get_pkg_info("worldriskpollr");
library(pkgfilecache)
# Set up data frame
pkg_info = get_pkg_info("worldriskpollr");
file_path = file.path(get_cache_dir(pkg_info), "sysdata.rda")
file_path
source("~/github/worldriskpollr/R/01-wrp_sysdata.R")
readRDS(.wrp_sysdata_file_path())
wrp <- readRDS(.wrp_sysdata_file_path())
library(worldriskpollr)
x = wrp_search("violence")
wrp_get(geography = "country", wrp_question_uid = "Q1")
source("~/github/worldriskpollr/data-raw/format_wrp_from_raw.R")
saveRDS(wrp, file = "./data-raw/sysdata.rda", compress = "xz")
filename <- "sysdata.rda"
url <- c("https://github.com/githubIEP/worldriskpollr/raw/master/data-raw/sysdata.rda")
download.file(url, file.path( filename), mode = "wb")
roxygen2::roxygenise()
wrp_search("violence")
library(worldriskpollr)
wrp_search("violence")
wrp_get(geography = "country", wrp_question_uid = "Q1")
roxygen2::roxygenise()
roxygen2::roxygenise()
rhub::check_for_cran()
rhub::validate_email()
rhub::validate_email("dhammond@economicsandpeace.org")
rhub::check_for_cran()
results = devtools::check_win_devel()
library(testthat)
expect(1==1)
expect(1==1, failure_message = "Message")
expect(1==0, failure_message = "Message")
x=expect(1==0, failure_message = "Message")
x
x=expect(1==1, failure_message = "Message")
x
stopifnot("The World Risk Poll data does not exist", 1==1)
stopifnot(
"`geography` must be either `country` or `region`" = 1==1)
)
stopifnot(
"`geography` must be either `country` or `region`" = 1==1)
stopifnot(
"`geography` must be either `country` or `region`" = 1==0)
roxygen2::roxygenise()
roxygen2::roxygenise()
library(worldriskpollr)
wrp_search()
library(iepsqlite)
con <- connect_to_db(sharepoint_filepath("Institute for Economics and Peace/Research/Data/iepsqlite/etr-2022/iep-gadm404-levels.gpkg"))
con <- connect_to_db(sharepoint_filepath("/Institute for Economics and Peace/Research/Data/iepsqlite/etr-2022/iep-gadm404-levels.gpkg"))
sharepoint_filepath("/Institute for Economics and Peace/Research/Data/iepsqlite/etr-2022/iep-gadm404-levels.gpkg")
connect_to_db
con <- connect_to_db("/Institute for Economics and Peace/Research/Data/iepsqlite/etr-2022/iep-gadm404-levels.gpkg")
db <- sharepoint_filepath("/Institute for Economics and Peace/Research/Data/iepsqlite/etr-2022/iep-gadm404-levels.gpkg")
con <- RSQLite::dbConnect(RSQLite::SQLite(), db)
comtrade <- dbReadTable(con, "trade")
max(comtrade$year[comtrade$ID_0=="CHN"])
max(comtrade$year[comtrade$ID_0=="CHN"], na.rm = T)
max(as.numeric(comtrade$year[comtrade$ID_0=="CHN"]), na.rm = T)
View(comtrade)
?rlang::on_load
roxygen2::roxygenise()
roxygen2::roxygenise()
roxygen2::roxygenise()
roxygen2::roxygenise()
roxygen2::roxygenise()
roxygen2::roxygenise()
roxygen2::roxygenise()
roxygen2::roxygenise()
roxygen2::roxygenise()
roxygen2::roxygenise()
roxygen2::roxygenise()
roxygen2::roxygenise()
library(worldriskpollr)
wrp_search("violence")
library(worldriskpollr)
roxygen2::roxygenise()
roxygen2::roxygenise()
source("~/github/worldriskpollr/R/01-wrp_folder_and_filepath.R")
.wrp_sysdata_file_path()
path.package("worldriskpollr")
library(worldriskpollr)
path.package("worldriskpollr")
roxygen2::roxygenise()
roxygen2::roxygenise()
roxygen2::roxygenise()
roxygen2::roxygenise()
library(worldriskpollr)
roxygen2::roxygenise()
roxygen2::roxygenise()
roxygen2::roxygenise()
roxygen2::roxygenise()
roxygen2::roxygenise()
??tidy_download
usethis::create_download_url
?usethis::create_download_url
roxygen2::roxygenise()
roxygen2::roxygenise()
roxygen2::roxygenise()
roxygen2::roxygenise()
roxygen2::roxygenise()
roxygen2::roxygenise()
library(worldriskpollr)
wrp_search("violence")
wrp_get(geography = "country", wrp_question_uid = "Q1")
roxygen2::roxygenise()
roxygen2::roxygenise()
?.onAttach
roxygen2::roxygenise()
url <- "https://github.com/githubIEP/worldriskpollr/raw/master/data-raw/sysdata.rdas"
temp <- tempfile()
x = download.file(url, temp, mode = 'wb', quiet = TRUE)
x
x = tryCatch(download.file(url, temp, mode = 'wb', quiet = TRUE))
x
x = try(download.file(url, temp, mode = 'wb', quiet = TRUE))
x
class(x)
roxygen2::roxygenise()
library(worldriskpollr)
wrp_search("violence")
library(worldriskpollr)
library(worldriskpollr)
library(worldriskpollr)
library(worldriskpollr)
library(worldriskpollr)
source("~/github/worldriskpollr/R/zzz.R")
.onLoad()
roxygen2::roxygenise()
library(worldriskpollr)
roxygen2::roxygenise()
roxygen2::roxygenise()
roxygen2::roxygenise()
roxygen2::roxygenise()
roxygen2::roxygenise()
roxygen2::roxygenise()
roxygen2::roxygenise()
lintr:::addin_lint_package()
lintr:::addin_lint_package()
lintr:::addin_lint_package()
roxygen2::roxygenise()
devtools::check_win_devel()
